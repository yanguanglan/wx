zuche.modules.vehicle=(function(){function toggleSuit(target){if(target.tagName.toLowerCase()=="span"){target=$(target).parent();}var content=$(target).next();if($(target).hasClass("open")){$(target).removeClass("open").addClass("close");$(content).fadeOut();$(content).hide();}else{$(target).removeClass("close").addClass("open");$(content).fadeIn();}}function bindEvent(rent){$(document).delegate(".suit .head","click",function(e){var target=e.target;toggleSuit(target);});$(document).delegate("#condition .item","click",function(e){var target=e.target;if($(target).hasClass("active")){}else{$("#condition .active").removeClass("active");$(target).addClass("active");var level=$(target).attr("data-code");var param=zuche.modules.vehicle.filterParam;param.vehicleLevel=level;getAllModePrice();}});$("#filterByAll").click(function(){var param=zuche.modules.vehicle.filterParam;var chx=$("#filterByAllChx");if(param.availableOnly=="Y"){param.availableOnly="N";chx.removeClass("checked");}else{param.availableOnly="Y";chx.addClass("checked");}getAllModePrice();});$("#filterByPrice").click(function(){var param=zuche.modules.vehicle.filterParam;if(param.sortType=="asc"){param.sortType="desc";$("#filterByPrice .arrow-line").removeClass("up");}else{param.sortType="asc";$("#filterByPrice .arrow-line").addClass("up");}getAllModePrice();});$("#filterByLevel").click(function(){$("#condition").slideToggle("slow");});$(document).delegate("#list .rent","click",function(){var id=$(this).attr("data-id");var vehicle=getModalByModalId(id);vehicle.calculateOtherPrice=$("#calculateOtherPrice"+id).val();var day=zuche.models.rent.get("rentPeriod");if(day){day=day.replace("天","");}if($(this).attr("data-suit")=="true"||(day&&day>27)){vehicle.orderType=1;}else{vehicle.orderType=0;}vehicle.isSendMoney=0;if($(this).attr("rent-type")=="pre"){vehicle.isSendMoney=1;}if(vehicle){var rentCity=zuche.models.rent.get("rentCity");var returnCity=zuche.models.rent.get("returnCity");if(rentCity.xid=="6"&&returnCity.xid!="6"){if(vehicle.modeName.indexOf("沪")!=-1){zuche.utils.dialog.error("沪牌车暂不接受异地还车！");return false;}}zuche.models.rent.set("rentVehicle",vehicle);zuche.models.rent.remove("promotion");zuche.models.rent.remove("additionalServiceList");location.href="/html5/order/service.html?v="+Math.ceil(new Date());}});}function getVehiclesByCondition(params,callback){if(typeof params!=="string"){params=JSON.stringify(params);}zuche.utils.ajax({url:"/webservice/vehicle/getVehiclesByCondition.do",data:{queryString:params},dataType:"json",type:"post"},callback);}function getModeLevelList(callback){zuche.utils.ajax({url:"/webservice/vehicle/modelLevelList.do",dataType:"json",type:"post"},callback);}function searchByLevel(level){getAllModePrice(function(modes){if(!level){}else{modes=$.grep(modes,function(mode){return mode.modeLevel==level;});}$("#list").html($("#modeListTemplate").render({modeList:modes}));});}function getModalByModalId(id){var modals=zuche.modules.vehicle.modals,result=null;$.each(modals,function(i,vehicle){if(vehicle.modeId==id){result=vehicle;return false;}});return result;}function getAllModePrice(callback){function filterModes(modes,orderTypeDes){var filterParam=zuche.modules.vehicle.filterParam;zuche.modules.vehicle.modals=modes;if(filterParam.sortType=="asc"){modes=modes.sort(function(a,b){return a.price.standAvePrice-b.price.standAvePrice;});}else{modes=modes.sort(function(a,b){return b.price.standAvePrice-a.price.standAvePrice;});}var haveCarSpecialMode=$.grep(modes,function(mode){return mode.stockCount==1&&mode.modeLevel==10;});var changeDepTimeSpecialMode=$.grep(modes,function(mode){return mode.stockCount==2&&mode.modeLevel==10;});var changeDepSpecialMode=$.grep(modes,function(mode){return mode.stockCount==4&&mode.modeLevel==10;});if(filterParam.availableOnly=="Y"){modes=$.grep(modes,function(mode){if(orderTypeDes){mode.orderTypeDes=orderTypeDes;}return mode.stockCount==1;});}var tmpAvalible=$.grep(modes,function(mode){if(haveCarSpecialMode){return mode.stockCount==1&&mode.modeLevel!=10;}else{return mode.stockCount==1;}});var tmpDepTimeMode=$.grep(modes,function(mode){if(changeDepTimeSpecialMode){return mode.stockCount==2&&mode.modeLevel!=10;}else{return mode.stockCount==2;}});var tmpDepMode=$.grep(modes,function(mode){if(changeDepSpecialMode){return mode.stockCount==4&&mode.modeLevel!=10;}else{return mode.stockCount==4;}});var tmpTimeMode=$.grep(modes,function(mode){return mode.stockCount==3;});var tmpOtherMode=$.grep(modes,function(mode){return mode.stockCount==5;});modes=haveCarSpecialMode.concat(changeDepTimeSpecialMode).concat(changeDepSpecialMode).concat(tmpAvalible).concat(tmpDepTimeMode).concat(tmpDepMode).concat(tmpTimeMode).concat(tmpOtherMode);if(filterParam.vehicleLevel!="0"){modes=$.grep(modes,function(mode){return mode.modeLevel==filterParam.vehicleLevel;});}if(modes[0]){modes[0].defaultOpen=true;}return modes;}var modes=zuche.modules.vehicle.modals;if(!modes){var params=zuche.models.rent.getParams();var calpreferenceprice=zuche.utils.getSession("calpreferenceprice");calpreferenceprice=calpreferenceprice==1?1:0;var param={fromCityId:params.fromCity,toCityId:params.toCity,fromStoreId:params.fromStore,toStoreId:params.toStore,fromDate:params.fromDate,toDate:params.toDate,availableOnly:"N",calpreferenceprice:calpreferenceprice};zuche.utils.ajax({url:"/webservice/vehicle/getVehiclesByCondition.do",data:{queryString:JSON.stringify(param)},dataType:"json",type:"post"},function(json){modes=filterModes(json.modeList,json.orderTypeDes);$("#list").html($("#modeListTemplate").render({modeList:modes}));});}else{modes=filterModes(modes);$("#list").html($("#modeListTemplate").render({modeList:modes}));}}return{modals:null,filterParam:{availableOnly:"Y",sortType:"asc",vehicleLevel:"0"},init:function(){var rent=zuche.models.rent.getFromDB();if(!rent){zuche.utils.dialog.error("出错了，参数不全");return false;}this.rent=rent;zuche.models.rent.renderView("store","storeTemplate");bindEvent(rent);getAllModePrice();getModeLevelList(function(json){$("#condition").html($("#levelTemplate").render(json.dataDictList));$("#condition .item").first().addClass("active");});}};})();zuche.modules.vehicle.init();